<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AVALIA NR01 — Dashboard</title>

  <!-- Tema claro novo -->
  <link rel="stylesheet" href="assets/branding.css">

  <!-- Chart.js para o gráfico radar -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <!-- NAVBAR -->
  <nav>
    <div class="wrap">
      <div class="logo">
        <img src="assets/logo.svg" alt="Logo AVALIA NR01">
        <span>AVALIA NR01</span>
      </div>

      <div style="margin-left:auto; display:flex; gap:8px;">
        <a class="btn secondary" href="campaigns.html">Campanhas</a>
        <a class="btn secondary" href="report.html">Relatórios</a>
        <button onclick="logout()" class="btn danger">Sair</button>
      </div>
    </div>
  </nav>

  <!-- CONTEÚDO PRINCIPAL -->
  <div class="container">
    <div class="card dashboard-card">
      <h2 style="margin-top:0; margin-bottom:4px;">Visão Geral</h2>
      <p class="small" style="margin-top:0; margin-bottom:16px;">
        Resumo das médias por dimensão psicossocial e sugestões de plano de ação para a campanha selecionada.
      </p>

      <!-- LAYOUT DIVIDIDO (esquerda radar / direita plano de ação) -->
      <div class="grid">
        <div class="col-6 dashboard-left">
          <h3 class="section-title">Médias por dimensão</h3>
          <canvas id="radar"></canvas>
        </div>

        <div class="col-6 dashboard-right">
          <h3 class="section-title">Plano de ação sugerido</h3>
          <div id="actions"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">© 2025 AVALIA NR01</div>

  <script>
    let token = localStorage.getItem('token');
    if (!token) location.href = 'index.html';

    async function load() {
      const camps = await fetch('/api/campaigns', {
        headers: { Authorization: 'Bearer ' + token }
      }).then(r => r.json());

      const actionsContainer = document.getElementById('actions');

      if (!camps.length) {
        actionsContainer.innerHTML =
          '<p class="small">Nenhuma campanha encontrada. Crie uma campanha em <b>Campanhas</b> para visualizar o painel.</p>';
        return;
      }

      const sum = await fetch('/api/summary/' + camps[0].id, {
        headers: { Authorization: 'Bearer ' + token }
      }).then(r => r.json());

      const labels = Object.keys(sum.average);
      const data = Object.values(sum.average);

      new Chart(document.getElementById('radar'), {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Média (1-5)',
            data: data,
            fill: true
          }]
        },
        options: {
          plugins: {
            legend: {
              labels: { color: '#0f172a' }   // texto escuro pra combinar com fundo claro
            }
          },
          scales: {
            r: {
              angleLines: { color: 'rgba(148,163,184,0.45)' },
              grid: { color: 'rgba(148,163,184,0.35)' },
              pointLabels: { color: '#0f172a' },
              ticks: {
                backdropColor: 'transparent',
                color: '#64748b'
              }
            }
          }
        }
      });

      const list = (sum.actions || [])
        .map(a => {
          const pri = (a.priority || '').toLowerCase();
          let badgeLabel = a.priority || 'Ação';
          let badgeClass = 'badge';

          if (pri === 'alta') badgeClass += ' alta';
          if (pri === 'média' || pri === 'media') badgeClass += ' media';
          if (pri === 'manter') badgeClass += ' manter';

          return `
            <div class="card action-card">
              <div class="action-card-header">
                <div class="action-dimension">${a.dimension}</div>
                <span class="${badgeClass}">${badgeLabel}</span>
              </div>
              <p class="small" style="margin:0;">${a.suggestion}</p>
            </div>
          `;
        })
        .join('');

      actionsContainer.innerHTML = list || '<p class="small">Sem dados ainda.</p>';
    }

    load();

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }
  </script>

</body>
</html>

