<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AVALIA NR01 — Avaliação Psicossocial</title>
  <link rel="stylesheet" href="assets/branding.css">
</head>
<body>
  <div class="container">
    <div class="card" style="max-width:860px;margin:22px auto">
      <h2>Levantamento de Fatores Psicossociais</h2>
      <p class="small">Anônimo. Não colete dados pessoais. Responda conforme sua realidade.</p>

      <div class="grid">
        <div class="col-3"><input id="sector" placeholder="Setor (opcional)"></div>
        <div class="col-3"><input id="ghe" placeholder="GHE (opcional)"></div>
        <div class="col-3"><input id="ges" placeholder="GES (opcional)"></div>
        <div class="col-3"><input id="env" placeholder="Ambiente (opcional)"></div>
      </div>

      <div id="form"></div>

      <textarea id="notes" placeholder="Observações (opcional)" style="width:100%;margin-top:10px;height:80px"></textarea>
      <button class="btn" style="margin-top:14px" onclick="submitForm()">Enviar respostas</button>
    </div>
  </div>

  <div class="footer">© 2025 AVALIA NR01</div>

  <script>
    // === URL da API no Render ===
    const API_BASE = "https://psywork-nr01-api.onrender.com";

    // === Token da campanha na URL ===
    const token = new URLSearchParams(location.search).get('token');
    if (!token) {
      document.body.innerHTML =
        '<div class="container"><div class="card">Token inválido</div></div>';
    }

    const formDiv = document.getElementById('form');
    const dims = {};

    // === Questões do questionário ===
    const questions = [
      ["Demandas", "Sinto pressão de tempo para concluir minhas atividades."],
      ["Demandas", "O volume de trabalho tem sido excessivo."],
      ["Demandas", "Minhas tarefas exigem ritmo muito intenso."],
      ["Controle", "Tenho autonomia para decidir como executar meu trabalho."],
      ["Controle", "Posso ajustar prioridades conforme a realidade do setor."],
      ["Controle", "Consigo usar minhas habilidades e criatividade nas tarefas."],
      ["Apoio", "Recebo apoio adequado da liderança quando preciso."],
      ["Apoio", "Recebo apoio dos colegas quando necessário."],
      ["Apoio", "Tenho acesso a recursos/treinamentos para realizar meu trabalho."],
      ["Relações", "O ambiente é respeitoso (sem assédio/violência)."],
      ["Relações", "Conflitos são tratados de forma justa e rápida."],
      ["Relações", "Sinto que pertenço ao time/empresa."],
      ["Papel", "Meus papéis e responsabilidades são claros."],
      ["Papel", "Metas e expectativas são bem comunicadas."],
      ["Papel", "Tenho clareza sobre critérios de avaliação de desempenho."],
      ["Mudanças", "Mudanças são comunicadas com antecedência."],
      ["Mudanças", "Recebo suporte durante períodos de mudança."],
      ["Mudanças", "Entendo os motivos e impactos das mudanças."],
      ["Demandas", "Tenho pausas adequadas durante a jornada."],
      ["Demandas", "Consigo conciliar trabalho e vida pessoal."],
      ["Controle", "Posso sugerir melhorias no processo de trabalho."],
      ["Apoio", "Recebo feedback construtivo com regularidade."],
      ["Relações", "Há cooperação entre setores."],
      ["Papel", "As prioridades não mudam sem justificativa."],
      ["Mudanças", "Mudanças são avaliadas quanto ao impacto psicossocial."],
      ["Demandas", "Tenho recursos suficientes para a carga de trabalho."],
      ["Controle", "Posso decidir quando realizar tarefas específicas."],
      ["Apoio", "Me sinto reconhecido pelo meu trabalho."],
      ["Relações", "Sinto que posso falar sem medo de retaliação."],
      ["Papel", "Tenho trilha clara de desenvolvimento na função."]
    ];

    // === Monta o formulário dinamicamente ===
    let idx = 1;
    questions.forEach(q => {
      dims[q[0]] = dims[q[0]] || [];
      dims[q[0]].push({ text: q[1], id: idx });
      idx++;
    });

    for (const [dim, arr] of Object.entries(dims)) {
      const sec = document.createElement('div');
      sec.className = 'card';
      sec.innerHTML = '<h3>' + dim + '</h3>';

      arr.forEach(item => {
        const row = document.createElement('div');
        row.style.margin = '12px 0';
        row.innerHTML =
          '<div>' + item.text + '</div>' +
          '<div><select id="q' + item.id + '">' +
          '<option value="">Selecione...</option>' +
          '<option value="1">1 — Discordo totalmente</option>' +
          '<option value="2">2 — Discordo</option>' +
          '<option value="3">3 — Neutro</option>' +
          '<option value="4">4 — Concordo</option>' +
          '<option value="5">5 — Concordo totalmente</option>' +
          '</select></div>';
        sec.appendChild(row);
      });

      formDiv.appendChild(sec);
    }

    // === Envio das respostas ===
    async function submitForm() {
      const answers = {};

      for (let i = 1; i <= questions.length; i++) {
        const v = document.getElementById('q' + i).value;
        if (!v) {
          alert('Responda todas as questões');
          return;
        }
        answers[i] = Number(v);
      }

      const payload = {
        token: token,
        sector: sector.value || null,
        ghe: ghe.value || null,
        ges: ges.value || null,
        environment: env.value || null,
        answers: answers,
        notes: notes.value || ''
      };

      try {
        const res = await fetch(`${API_BASE}/api/public/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          alert('Erro ao enviar');
          return;
        }

        document.body.innerHTML =
          '<div class="container"><div class="card">' +
          '<h2>Obrigado!</h2>' +
          '<p class="small">Suas respostas foram registradas.</p>' +
          '</div></div>';
      } catch (e) {
        alert('Erro de comunicação com o servidor.');
      }
    }
  </script>
</body>
</html>
